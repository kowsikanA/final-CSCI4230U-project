<!DOCTYPE html>
<html lang="en">
  <head>
    <title>NorthStar Goods</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  </head>
  <body>
    <!-- Navbar -->
    <div class="navbar">
      <img src="{{ url_for('static', filename='images/logo.png') }}" alt="logo" class="logo" height="150px" width="150px">
      <div class="search-bar">
        <input type="search" name="product-search" id="product-search" placeholder="Search for products">
        <button class="search-btn"><i class="fa fa-search"></i></button>
      
      </div>
      <ul class="nav-links">
        <li class="link"><a href="{{ url_for('login') }}">Sign In</a></li>
        <li class="link"><a href=""><img src="https://img.icons8.com/?size=100&id=ldYAIOBZuEdB&format=png&color=000000" alt="" width="50px" height="50px"></a></li>
      </ul>
    </div>
    
    <div id="product-list">
      
    </div>
    
    <!-- Code for chatbox -sr -->
    <div id="chat-widget">
      <div class="chat-header">NorthStar Assistant</div>
      <div class="chat-body" id="chat-body">
        <div class="chat-message bot">
          Hi! ðŸ‘‹. Have any questions about the products we sell, go ahead and ask us some questions. 
        </div>
      </div>
      <div class="chat-input-row">
        <input type="text" id="chat-input" placeholder="What is the latest airpod generation?" autocomplete="off"/>
        <button id="chat-send">Send</button>
      </div>
    </div>
    <button id="chat-toggle" aria-label="Open chat">ðŸ’¬</button>

  </body>

  <script>
      async function fetchProducts(){
        try{
          const res = await fetch('/api/products');
          if (!res.ok){
            throw new Error(`Response status: ${res.status}`);         
          }
          const productList = await res.json();
          
          const productListDiv = document.getElementById('product-list');
          productList.forEach(product => {
            const productDiv = document.createElement('div');
            const img = document.createElement('img');
            const price = document.createElement('h3');

            productDiv.className = 'product';

            img.src = product.image_url;
            img.alt = product.name;
            img.className = 'product-image';
            
            price.innerHTML = `Price: $${product.price}`
            price.className = 'product-price'

            productDiv.appendChild(img);
            productDiv.appendChild(price);
            
            productListDiv.appendChild(productDiv)

          });



        } catch (error){
          console.error(error.message)
        }
      }
      fetchProducts();
  </script>

 <script>

  // ----- Chat widget logic -----
  const chatWidget = document.getElementById("chat-widget");
  const chatToggle = document.getElementById("chat-toggle");
  const chatBody = document.getElementById("chat-body");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");

  function appendMessage(role, text) {
    const msg = document.createElement("div");
    msg.className = "chat-message " + role;
    msg.textContent = text;
    chatBody.appendChild(msg);
    chatBody.scrollTop = chatBody.scrollHeight;
    return msg;
  }

  async function sendChat() {
    const text = (chatInput.value || "").trim();
    if (!text) return;

    appendMessage("user", text);
    chatInput.value = "";

    const thinkingEl = appendMessage("bot", "Thinking...");

    try {
      const resp = await fetch("/ai/ask", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ prompt: text }),
      });

      if (!resp.ok) {
        thinkingEl.textContent = "Error: " + resp.status;
        return;
      }

      const data = await resp.json();
      thinkingEl.textContent = data.output || "(No response from model.)";
    } catch (err) {
      console.error(err);
      thinkingEl.textContent = "Network error. Please try again.";
    }
  }

  // Toggle open/close when clicking the bubble
  chatToggle.addEventListener("click", () => {
    chatWidget.classList.toggle("open");
  });

  // Send on button click
  chatSend.addEventListener("click", sendChat);

  // Send on Enter key (Shift+Enter = newline ignored since it's a single-line input)
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendChat();
    }
  });
</script>
  
</html>