<!DOCTYPE html>
<html lang="en">
<head>
  <title></title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style/carts.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet"
  >
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
  >
</head>

<body>
  <!-- Navbar -->
  <div class="main-navbar">
    <div class="navbar">
      <a href="{{ url_for('home') }}">
        <img
          src="{{ url_for('static', filename='images/logo-2.png') }}"
          alt="logo"
          class="logo"
        >
      </a>

      <ul class="nav-links">
        <div class="search-bar">
          <form action="">
            <input
              type="search"
              name="product-search"
              id="product-search"
              placeholder="Search for products"
            >
            <button class="search-btn">
              <i class="fa fa-search"></i>
            </button>
          </form>
        </div>
        <li class="link">
          <a href="{{ url_for('login') }}" id="auth-link">Sign In</a>
        </li>
        <li class="link">
          <a href="">
            <i
              class="fa fa-shopping-cart cart-icon"
              aria-hidden="true"
              style="font-size: 24px;"
            ></i>
          </a>
        </li>
      </ul>
    </div>

    <div class="carts">
      <table class="carts-table">
        <tr>
          <th>Product</th>
          <th>Quantity</th>
          <th>Cost</th>
          <th>Total Cost</th>
          <th>Action</th>
        </tr>
      </table>
    </div>

    <div class="cost-info">
      <h2 class="subtotal">Total Cost $1.00</h2>
      <button id="checkout-btn">Proceed to Checkout</button>
    </div>

    <div id="chat-widget">
      <div class="chat-header">NorthStar Assistant</div>
      <div class="chat-body" id="chat-body">
        <div class="chat-message bot">
          Hi! ðŸ‘‹. Have any questions about the products we sell, go ahead and ask us some questions.
        </div>
      </div>
      <div class="chat-input-row">
        <input
          type="text"
          id="chat-input"
          placeholder="What is the latest airpod generation?"
          autocomplete="off"
        >
        <button id="chat-send">Send</button>
      </div>
    </div>
    <button id="chat-toggle" aria-label="Open chat">ðŸ’¬</button>
  </div>

  <div id="notification" class="notification"></div>
</body>

<!-- Login/Logout Checker -->
<script>
  (function () {
    const FLAG_KEY = "ns_initial_logout_done";

    if (!sessionStorage.getItem(FLAG_KEY)) {
      localStorage.removeItem("access_token");
      sessionStorage.setItem(FLAG_KEY, "1");
    }
  })();

  function handleLogout(event) {
    event.preventDefault();
    localStorage.removeItem("access_token");
    window.location.href = "{{ url_for('login') }}";
  }

  function updateAuthLink() {
    const authLink = document.getElementById("auth-link");
    if (!authLink) return;

    const token = localStorage.getItem("access_token");

    if (token) {
      authLink.textContent = "Sign Out";
      authLink.href = "#";
      authLink.onclick = handleLogout;
    } else {
      authLink.textContent = "Sign In";
      authLink.href = "{{ url_for('login') }}";
      authLink.onclick = null;
    }
  }

  document.addEventListener("DOMContentLoaded", updateAuthLink);
</script>

<script>
  // Chat widget logic
  const chatWidget = document.getElementById("chat-widget");
  const chatToggle = document.getElementById("chat-toggle");
  const chatBody = document.getElementById("chat-body");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");

  function appendMessage(role, text) {
    const msg = document.createElement("div");
    msg.className = "chat-message " + role;
    msg.textContent = text;
    chatBody.appendChild(msg);
    chatBody.scrollTop = chatBody.scrollHeight;
    return msg;
  }

  async function sendChat() {
    const text = (chatInput.value || "").trim();
    if (!text) return;

    appendMessage("user", text);
    chatInput.value = "";

    const thinkingEl = appendMessage("bot", "Thinking...");

    try {
      const resp = await fetch("/ai/ask", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ prompt: text }),
      });

      if (!resp.ok) {
        thinkingEl.textContent = "Error: " + resp.status;
        return;
      }

      const data = await resp.json();
      thinkingEl.textContent = data.output || "(No response from model.)";
    } catch (err) {
      console.error(err);
      thinkingEl.textContent = "Network error. Please try again.";
    }
  }

  chatToggle.addEventListener("click", () => {
    chatWidget.classList.toggle("open");
  });

  chatSend.addEventListener("click", sendChat);

  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendChat();
    }
  });
</script>

<script>
  let subtotal = 0.0;
  const subTotalEl = document.querySelector(".subtotal");

  async function loadCart() {
    const token = localStorage.getItem("access_token");
    subtotal = 0;

    if (!token) {
      console.log("No token found â†’ user not logged in.");
      return;
    }

    try {
      const resp = await fetch("/api/cart", {
        method: "GET",
        headers: {
          "Authorization": "Bearer " + token,
        },
      });

      if (!resp.ok) {
        console.error("Failed to load cart", resp.status);
        return;
      }

      const cartData = await resp.json();
      console.log("Cart Data:", cartData);

      const table = document.querySelector(".carts-table");
      table.querySelectorAll("tr:not(:first-child)").forEach((row) => row.remove());

      for (const item of cartData) {
        const productResp = await fetch(`https://dummyjson.com/products/${item.product_id}`);
        const product = await productResp.json();

        const productImage = product.thumbnail;
        const productPrice = product.price;
        const totalCost = (productPrice * item.quantity).toFixed(2);
        subtotal += parseFloat(totalCost);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <img src="${productImage}" alt="Product Image" style="width:50px;height:50px;">
          </td>
          <td>${item.quantity}</td>
          <td>$${productPrice}</td>
          <td>$${totalCost}</td>
          <td>
            <button
              class="delete-btn"
              data-cart-id="${item.id}"
            >
              Remove
            </button>
          </td>
        `;

        table.appendChild(row);
      }

      subTotalEl.textContent = `Total Cost $${subtotal.toFixed(2)}`;
      localStorage.setItem("cart_subtotal", subtotal.toFixed(2));
    } catch (err) {
      console.error("Error loading cart:", err);
    }
  }

  // Delete cart item (event delegation)
  document.querySelector(".carts-table").addEventListener("click", async (e) => {
    if (!e.target.classList.contains("delete-btn")) return;

    const btn = e.target;
    const cartId = btn.dataset.cartId;
    const token = localStorage.getItem("access_token");

    if (!token) {
      showNotification("You must be signed in to modify your cart.","error");
      return;
    }

    const confirmDelete = confirm("Remove this item from your cart?");
    if (!confirmDelete) return;

    try {
      const resp = await fetch(`/api/cart/${cartId}`, {
        method: "DELETE",
        headers: {
          "Authorization": "Bearer " + token,
        },
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        showNotification("Could not delete this item.","error");
        
        return;
      }

      const row = btn.closest("tr");
      const totalCell = row.querySelector(".row-total");

      if (totalCell) {
        const value = parseFloat(totalCell.textContent.replace("$", "")) || 0;
        subtotal -= value;
        if (subtotal < 0) subtotal = 0;

        subTotalEl.textContent = `Total Cost $${subtotal.toFixed(2)}`;
        localStorage.setItem("cart_subtotal", subtotal.toFixed(2));
      }

      row.remove();
    } catch (err) {
      console.error("Error deleting cart item:", err);
      showNotification("Network error. Please try again.","error");
    }
  });

  // Checkout (Stripe)
  document.getElementById("checkout-btn").addEventListener("click", async () => {
    if (subtotal <= 0) {
      showNotification("You cart is empty","error");
      return;
    }

    const token = localStorage.getItem("access_token");
    if (!token) {
      showNotification("You must be signed in to checkout.", "error");
      window.location.href = "{{ url_for('login') }}";
      return;
    }

    try {
      const resp = await fetch("/payments/checkout", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token,
        },
      });

      const data = await resp.json();

      if (!resp.ok) {
        showNotification("Failed to start payment.", "error");
        return;
      }

      window.location.href = data.checkout_url;
    } catch (err) {
      console.error(err);
      showNotification("Network error starting checkout.", "error");
    }
  });

  window.addEventListener("DOMContentLoaded", loadCart);
</script>

<!-- Notification helper -->
  <script>
    const notificationEl = document.getElementById("notification");
    let notificationTimeout;

    function showNotification(message, type = "success", duration = 3000) {
      if (!notificationEl) return;

      notificationEl.className = "notification";
      notificationEl.textContent = message;

      if (type === "success") {
        notificationEl.classList.add("notification-success");
      } else if (type === "error") {
        notificationEl.classList.add("notification-error");
      }

      notificationEl.classList.add("show");

      if (notificationTimeout) {
        clearTimeout(notificationTimeout);
      }
      notificationTimeout = setTimeout(() => {
        notificationEl.classList.remove("show");
      }, duration);
    }

    notificationEl?.addEventListener("click", () => {
      notificationEl.classList.remove("show");
    });
  </script>
</html>
