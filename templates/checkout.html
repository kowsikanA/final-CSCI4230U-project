<!DOCTYPE html>
<html lang="en">
<head>
  <title></title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style/checkout.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet"
  >
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  >
</head>

<body>
  <!-- Navbar -->
  <div class="main-navbar">
    <div class="navbar">
      <a href="{{ url_for('home') }}">
        <img
          src="{{ url_for('static', filename='images/logo-2.png') }}"
          alt="logo"
          class="logo"
        >
      </a>

      <ul class="nav-links">
        <div class="search-bar">
          <form action="">
            <input
              type="search"
              name="product-search"
              id="product-search"
              placeholder="Search for products"
            >
            <button class="search-btn">
              <i class="fa fa-search"></i>
            </button>
          </form>
        </div>
        <li class="link">
          <a href="{{ url_for('login') }}" id="auth-link">Sign In</a>
        </li>
        <li class="link">
          <a href="">
            <i
              class="fa fa-shopping-cart cart-icon"
              aria-hidden="true"
              style="font-size: 24px;"
            ></i>
          </a>
        </li>
      </ul>
    </div>

    <div class="categories">
      <ul>
        <li style="font-weight: 500;">Black Friday</li>
        <li>Electronics</li>
        <li>Home Appliances</li>
        <li>Clothes</li>
        <li>Sports</li>
        <li>Gaming</li>
        <li>Toys</li>
        <li>Groceries</li>
      </ul>
    </div>
  </div>

  <section>
    <div class="checkout-container">
      <h1>Checkout</h1>

      <form action="javascript:void(0);" class="cart-information">
        <label for="cardholder">Card Holder</label>
        <input type="text" id="cardholder" placeholder="Cardholder Name">

        <label for="cardNumber">Card Number</label>
        <input
          type="text"
          name="cardNumber"
          id="cardNumber"
          placeholder="**** **** **** 1111"
          pattern="([0-9]{4}\s){3}[0-9]{4}"
        >

        <div>
          <div>
            <label for="expiryDate">Expiry Date</label>
            <input
              type="text"
              name="expiryDate"
              id="expiryDate"
              placeholder="MM/YY"
              pattern="(0[0-9]|1[0-2])\/[0-9]{2}"
            >
          </div>
          <div>
            <label for="cvv">CVV Number</label>
            <input type="text" name="cvv" id="cvv" placeholder="CVV">
          </div>
        </div>
      </form>

      <button class="payment-btn">
        <i
          class="fa-solid fa-money-bill"
          style="color: whitesmoke; margin-right: 10px;"
        ></i>
        Pay Now
      </button>
    </div>

    <div class="order-information">
      <h2>Order Summary</h2>
      <div class="order-details">
        <h4 id="order-total">Order total: $0.00</h4>
        <h4>Estimation Shipping:</h4>
        <h4>Estimated Tax: $0.00</h4>
      </div>
    </div>
  </section>

  <div id="chat-widget">
    <div class="chat-header">NorthStar Assistant</div>
    <div class="chat-body" id="chat-body">
      <div class="chat-message bot">
        Hi! ðŸ‘‹. Have any questions about the products we sell, go ahead and ask us some questions.
      </div>
    </div>
    <div class="chat-input-row">
      <input
        type="text"
        id="chat-input"
        placeholder="What is the latest airpod generation?"
        autocomplete="off"
      >
      <button id="chat-send">Send</button>
    </div>
  </div>
  <button id="chat-toggle" aria-label="Open chat">ðŸ’¬</button>
</body>

<!-- Chat widget -->
<script>
  const chatWidget = document.getElementById("chat-widget");
  const chatToggle = document.getElementById("chat-toggle");
  const chatBody = document.getElementById("chat-body");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");

  function appendMessage(role, text) {
    const msg = document.createElement("div");
    msg.className = "chat-message " + role;
    msg.textContent = text;
    chatBody.appendChild(msg);
    chatBody.scrollTop = chatBody.scrollHeight;
    return msg;
  }

  async function sendChat() {
    const text = (chatInput.value || "").trim();
    if (!text) return;

    appendMessage("user", text);
    chatInput.value = "";

    const thinkingEl = appendMessage("bot", "Thinking...");

    try {
      const resp = await fetch("/ai/ask", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ prompt: text }),
      });

      if (!resp.ok) {
        thinkingEl.textContent = "Error: " + resp.status;
        return;
      }

      const data = await resp.json();
      thinkingEl.textContent = data.output || "(No response from model.)";
    } catch (err) {
      console.error(err);
      thinkingEl.textContent = "Network error. Please try again.";
    }
  }

  chatToggle.addEventListener("click", () => {
    chatWidget.classList.toggle("open");
  });

  chatSend.addEventListener("click", sendChat);

  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendChat();
    }
  });
</script>

<!-- Checkout functionality -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // 1) Load subtotal from local storage into order summary
    const total = localStorage.getItem("cart_subtotal");
    const totalEl = document.getElementById("order-total");
    if (total && totalEl) {
      totalEl.textContent = `Order total: $${total}`;
    }

    // 2) Update auth link based on presence of token
    const authLink = document.getElementById("auth-link");
    const token = localStorage.getItem("access_token");

    if (authLink) {
      if (token) {
        authLink.textContent = "Sign Out";
        authLink.href = "#";
        authLink.onclick = function (e) {
          e.preventDefault();
          localStorage.removeItem("access_token");
          window.location.href = "{{ url_for('login') }}";
        };
      } else {
        authLink.textContent = "Sign In";
        authLink.href = "{{ url_for('login') }}";
      }
    }

    // 3) Stripe checkout handler
    const payBtn = document.querySelector(".payment-btn");
    if (!payBtn) return;

    payBtn.addEventListener("click", async () => {
      const storedToken = localStorage.getItem("access_token");
      if (!storedToken) {
        alert("You must be logged in to checkout.");
        window.location.href = "{{ url_for('login') }}";
        return;
      }

      const name = document.getElementById("cardholder").value.trim();
      const number = document.getElementById("cardNumber").value.trim();
      const expiry = document.getElementById("expiryDate").value.trim();
      const cvv = document.getElementById("cvv").value.trim();

      if (!name || !number || !expiry || !cvv) {
        alert("Please fill in all card details.");
        return;
      }

      // Basic front-end validation for mock card details
      if (number.length < 12 || cvv.length < 3) {
        alert("Please enter a valid mock card number and CVV.");
        return;
      }

      try {
        const resp = await fetch("/payments/checkout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + storedToken,
          },
        });

        const data = await resp.json();

        if (!resp.ok) {
          alert(data.error || "Failed to start payment.");
          return;
        }

        // Redirect to Stripe Checkout
        window.location.href = data.checkout_url;
      } catch (err) {
        console.error(err);
        alert("Network error starting checkout.");
      }
    });
  });
</script>
</html>
