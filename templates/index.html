<!DOCTYPE html>
<html lang="en">
  <head>
    <title>NorthStar Goods</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/style.css') }}">
  </head>
  <body>
    <!-- Navbar -->
    <div class="navbar">
      <img src="{{ url_for('static', filename='images/logo.png') }}" alt="logo" class="logo" height="200px" width="200px">
      <div class="search-bar">
        <input type="search" name="product-search" id="product-search" placeholder="Search for products">
        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="25" height="25" viewBox="0 0 50 50">
          <path
            d="M 21 3 C 11.621094 3 4 10.621094 4 20 C 4 29.378906 11.621094 37 21 37 C 24.710938 37 28.140625 35.804688 30.9375 33.78125 L 44.09375 46.90625 L 46.90625 44.09375 L 33.90625 31.0625 C 36.460938 28.085938 38 24.222656 38 20 C 38 10.621094 30.378906 3 21 3 Z M 21 5 C 29.296875 5 36 11.703125 36 20 C 36 28.296875 29.296875 35 21 35 C 12.703125 35 6 28.296875 6 20 C 6 11.703125 12.703125 5 21 5 Z">
          </path>
        </svg>
      </div>
      <ul class="nav-links">
        <li class="link"><a href="">Sign In</a></li>
        <li class="link"><a href=""><img src="https://img.icons8.com/?size=100&id=ldYAIOBZuEdB&format=png&color=000000" alt="" width="50px" height="50px"></a></li>
      </ul>
    </div>
    
    <div id="product-list">
      
    </div>
    
    <!-- Code for chatbox -sr -->
    <div id="chat-widget">
      <div class="chat-header">NorthStar Assistant</div>
      <div class="chat-body" id="chat-body">
        <div class="chat-message bot">
          Hi! ðŸ‘‹. Have any questions about the products we sell, go ahead and ask us some questions. 
        </div>
      </div>
      <div class="chat-input-row">
        <input type="text" id="chat-input" placeholder="What is the latest airpod generation?" autocomplete="off"/>
        <button id="chat-send">Send</button>
      </div>
    </div>
    <button id="chat-toggle" aria-label="Open chat">ðŸ’¬</button>

  </body>

  <script>
      async function fetchProducts(){
        try{
          const res = await fetch('/api/products');
          if (!res.ok){
            throw new Error(`Response status: ${res.status}`);         
          }
          const productList = await res.json();
          
          const productListDiv = document.getElementById('product-list');
          productList.forEach(product => {
            const productDiv = document.createElement('div');
            const img = document.createElement('img');
            const price = document.createElement('h3');

            productDiv.className = 'product';

            img.src = product.image_url;
            img.alt = product.name;
            img.className = 'product-image';
            
            price.innerHTML = `Price: $${product.price}`
            price.className = 'product-price'

            productDiv.appendChild(img);
            productDiv.appendChild(price);
            
            productListDiv.appendChild(productDiv)

          });



        } catch (error){
          console.error(error.message)
        }
      }
      fetchProducts();
  </script>

 <script>

  // ----- Chat widget logic -----
  const chatWidget = document.getElementById("chat-widget");
  const chatToggle = document.getElementById("chat-toggle");
  const chatBody = document.getElementById("chat-body");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");

  function appendMessage(role, text) {
    const msg = document.createElement("div");
    msg.className = "chat-message " + role;
    msg.textContent = text;
    chatBody.appendChild(msg);
    chatBody.scrollTop = chatBody.scrollHeight;
    return msg;
  }

  async function sendChat() {
    const text = (chatInput.value || "").trim();
    if (!text) return;

    appendMessage("user", text);
    chatInput.value = "";

    const thinkingEl = appendMessage("bot", "Thinking...");

    try {
      const resp = await fetch("/ai/ask", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ prompt: text }),
      });

      if (!resp.ok) {
        thinkingEl.textContent = "Error: " + resp.status;
        return;
      }

      const data = await resp.json();
      thinkingEl.textContent = data.output || "(No response from model.)";
    } catch (err) {
      console.error(err);
      thinkingEl.textContent = "Network error. Please try again.";
    }
  }

  // Toggle open/close when clicking the bubble
  chatToggle.addEventListener("click", () => {
    chatWidget.classList.toggle("open");
  });

  // Send on button click
  chatSend.addEventListener("click", sendChat);

  // Send on Enter key (Shift+Enter = newline ignored since it's a single-line input)
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendChat();
    }
  });
</script>
  
</html>