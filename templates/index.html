<!DOCTYPE html>
<html lang="en">
  <head>
    <title>NorthStar Goods</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    >
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    >
  </head>

  <body>
    <!-- Navbar -->
    <div class="main-navbar">
      <div class="navbar">
        <a href="{{ url_for('home') }}">
          <img
            src="{{ url_for('static', filename='images/logo-2.png') }}"
            alt="logo"
            class="logo"
          >
        </a>

        <ul class="nav-links">
          <div class="search-bar">
            <form action="">
              <input
                type="search"
                name="product-search"
                id="product-search"
                placeholder="Search for products"
              >
              <button class="search-btn">
                <i class="fa fa-search"></i>
              </button>
            </form>
          </div>
          <li class="link">
            <a href="{{ url_for('login') }}" id="auth-link">Sign In</a>
          </li>
          <li class="link">
            <a href="{{ url_for('carts') }}">
              <i
                class="fa fa-shopping-cart cart-icon"
                aria-hidden="true"
                style="font-size: 24px;"
              ></i>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Special offer grid -->
    <div class="offers">
      <h1 style="color: #F8FAFC; font-size: 45px;">Black Friday Offers</h1>
      <div id="product-list"></div>
    </div>

    <!-- Product details modal -->
    <div id="product-modal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <button class="modal-close" id="modal-close">&times;</button>

        <img id="modal-image" class="modal-image" src="" alt="Product image">

        <h2 id="modal-title" class="modal-title"></h2>
        <p id="modal-category" class="modal-category"></p>
        <p id="modal-price" class="modal-price"></p>
        <p id="modal-description" class="modal-description"></p>

        <button id="modal-view-details" class="more-details-btn">View Details</button>
        <button id="modal-add-to-cart" class="cart-btn">Add to Cart</button>
      </div>
    </div>

    <!-- Chat widget -->
    <div id="chat-widget">
      <div class="chat-header">NorthStar Assistant</div>
      <div class="chat-body" id="chat-body">
        <div class="chat-message bot">
          Hi! ðŸ‘‹. Have any questions about the products we sell, go ahead and ask us some questions.
        </div>
      </div>
      <div class="chat-input-row">
        <input
          type="text"
          id="chat-input"
          placeholder="What is the latest airpod generation?"
          autocomplete="off"
        >
        <button id="chat-send">Send</button>
      </div>
    </div>
    <button id="chat-toggle" aria-label="Open chat">ðŸ’¬</button>

    <div id="notification" class="notification"></div>

    <!-- ================= FOOTER ================= -->
    <footer class="footer">
      <div class="footer-container">
        <div class="footer-section">
          <img
            src="{{ url_for('static', filename='images/logo-2.png') }}"
            class="footer-logo"
            alt="NorthStar Goods"
          >
          <p>Your trusted online store for tech, lifestyle, and more.</p>
        </div>

        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="{{ url_for('home') }}">Home</a></li>
            <li><a href="{{ url_for('carts') }}">My Cart</a></li>
            <li><a href="{{ url_for('login') }}">Sign In</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h4>Customer Service</h4>
          <ul>
            <li><a href="#">Contact Us</a></li>
            <li><a href="#">Refund Policy</a></li>
            <li><a href="#">Shipping Info</a></li>
            <li><a href="#">FAQ</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h4>Follow Us</h4>
          <div class="footer-socials">
            <a href="#"><i class="fa fa-facebook"></i></a>
            <a href="#"><i class="fa fa-instagram"></i></a>
            <a href="#"><i class="fa fa-twitter"></i></a>
            <a href="#"><i class="fa fa-youtube-play"></i></a>
          </div>
        </div>
      </div>

      <div class="footer-bottom">
        <p>Â© 2025 NorthStar Goods â€” All Rights Reserved.</p>
      </div>
    </footer>
    <!-- =============== END FOOTER =============== -->
  </body>

  <!-- Login / logout helper -->
  <script>
    (function () {
      const FLAG_KEY = "ns_initial_logout_done";

      if (!sessionStorage.getItem(FLAG_KEY)) {
        localStorage.removeItem("access_token");
        sessionStorage.setItem(FLAG_KEY, "1");
      }
    })();

    function handleLogout(event) {
      event.preventDefault();
      localStorage.removeItem("access_token");
      window.location.href = "{{ url_for('login') }}";
    }

    function updateAuthLink() {
      const authLink = document.getElementById("auth-link");
      if (!authLink) return;

      const token = localStorage.getItem("access_token");

      if (token) {
        authLink.textContent = "Sign Out";
        authLink.href = "#";
        authLink.onclick = handleLogout;
      } else {
        authLink.textContent = "Sign In";
        authLink.href = "{{ url_for('login') }}";
        authLink.onclick = null;
      }
    }

    document.addEventListener("DOMContentLoaded", updateAuthLink);
  </script>

  <!-- Product listing, modal, search -->
  <script>
    let selectedProduct = null;
    let allProducts = [];

    function renderProducts(products) {
      const productListDiv = document.getElementById("product-list");
      if (!productListDiv) {
        console.error("No element with id 'product-list' found in the DOM.");
        return;
      }

      productListDiv.innerHTML = "";

      if (!products || products.length === 0) {
        productListDiv.innerHTML = "<p style='color:white;'>No products found.</p>";
        return;
      }

      products.forEach((product) => {
        const productDiv = document.createElement("div");
        productDiv.className = "product";

        const img = document.createElement("img");
        img.src = product.thumbnail;
        img.alt = product.title;
        img.className = "product-image";

        const title = document.createElement("p");
        title.className = "product-name";
        title.textContent =
          product.title.length > 25
            ? product.title.substring(0, 25) + "..."
            : product.title;

        const price = document.createElement("h3");
        price.className = "product-price";
        price.textContent = `$${product.price}`;

        productDiv.addEventListener("click", () => {
          openProductModal(product);
        });

        productDiv.appendChild(img);
        productDiv.appendChild(title);
        productDiv.appendChild(price);

        productListDiv.appendChild(productDiv);
      });
    }

    async function fetchProducts() {
      try {
        const res = await fetch(
          "https://dummyjson.com/products?limit=0&select=title,price,thumbnail,category,description"
        );

        if (!res.ok) {
          throw new Error(`Response status: ${res.status}`);
        }

        const data = await res.json();
        let products = data.products || [];

        const allowedCategories = ["smartphones", "laptops", "mobile-accessories"];

        products = products.filter((product) =>
          allowedCategories.includes(product.category)
        );

        allProducts = products;
        renderProducts(products);
      } catch (error) {
        console.error("Error fetching products:", error);

        const productListDiv = document.getElementById("product-list");
        if (productListDiv) {
          productListDiv.innerHTML =
            "<p style='color:white;'>Sorry, we couldn't load the products right now.</p>";
        }

        showNotification(
          "We couldn't load products. Please refresh the page.",
          "error"
        );
      }
    }

    const modal = document.getElementById("product-modal");
    const modalImage = document.getElementById("modal-image");
    const modalTitle = document.getElementById("modal-title");
    const modalCategory = document.getElementById("modal-category");
    const modalPrice = document.getElementById("modal-price");
    const modalDescription = document.getElementById("modal-description");
    const modalCloseBtn = document.getElementById("modal-close");
    const modalAddToCartBtn = document.getElementById("modal-add-to-cart");
    const viewDetailsBtn = document.getElementById("modal-view-details");

    function openProductModal(product) {
      selectedProduct = product;

      modalImage.src = product.thumbnail;
      modalImage.alt = product.title;
      modalTitle.textContent = product.title;
      modalCategory.textContent = `Category: ${product.category}`;
      modalPrice.textContent = `Price: $${product.price}`;
      modalDescription.textContent =
        product.description || "No description available.";

      modal.classList.remove("hidden");
    }

    function closeProductModal() {
      modal.classList.add("hidden");
      selectedProduct = null;
    }

    modalCloseBtn.addEventListener("click", closeProductModal);

    modal.addEventListener("click", (e) => {
      if (e.target === modal || e.target.classList.contains("modal-backdrop")) {
        closeProductModal();
      }
    });

    modalAddToCartBtn.addEventListener("click", async () => {
      if (!selectedProduct) return;

      const token = localStorage.getItem("access_token");
      if (!token) {
        showNotification("Please sign in before adding items to your cart.", "error");
        setTimeout(() => {
          window.location.href = "/login";
        }, 2000);
        return;
      }

      try {
        const res = await fetch("/api/cart", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
          },
          body: JSON.stringify({
            product_id: selectedProduct.id,
            name: selectedProduct.title,
            price: selectedProduct.price,
            image_url: selectedProduct.thumbnail,
            description: selectedProduct.description,
            quantity: 1,
          }),
        });

        const data = await res.json();

        if (!res.ok) {
          const message = data.error || "Could not add this product to your cart.";
          showNotification(message, "error");
          return;
        }

        showNotification(
          `Added "${selectedProduct.title}" to your cart.`,
          "success"
        );
        closeProductModal();
      } catch (err) {
        console.error(err);
        showNotification(
          "We ran into a network error. Please try again in a moment.",
          "error"
        );
      }
    });

    viewDetailsBtn.addEventListener("click", () => {
      if (!selectedProduct) return;

      localStorage.setItem("selectedProductId", selectedProduct.id);
      window.location.href = "/productDetails";
    });

    const searchInput = document.getElementById("product-search");
    const searchButton = document.querySelector(".search-btn");

    function handleSearch() {
      if (!allProducts || allProducts.length === 0) return;

      const query = searchInput.value.trim().toLowerCase();

      if (!query) {
        renderProducts(allProducts);
        return;
      }

      const filtered = allProducts.filter((product) => {
        return (
          product.title.toLowerCase().includes(query) ||
          product.category.toLowerCase().includes(query)
        );
      });

      renderProducts(filtered);
    }

    if (searchInput && searchButton) {
      searchButton.addEventListener("click", (event) => {
        event.preventDefault();
        handleSearch();
      });

      searchInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          handleSearch();
        }
      });
    }

    fetchProducts();
  </script>

  <!-- Chat widget logic -->
  <script>
    const chatWidget = document.getElementById("chat-widget");
    const chatToggle = document.getElementById("chat-toggle");
    const chatBody = document.getElementById("chat-body");
    const chatInput = document.getElementById("chat-input");
    const chatSend = document.getElementById("chat-send");

    function appendMessage(role, text) {
      const msg = document.createElement("div");
      msg.className = "chat-message " + role;
      msg.textContent = text;
      chatBody.appendChild(msg);
      chatBody.scrollTop = chatBody.scrollHeight;
      return msg;
    }

    async function sendChat() {
      const text = (chatInput.value || "").trim();
      if (!text) return;

      appendMessage("user", text);
      chatInput.value = "";

      const thinkingEl = appendMessage("bot", "Thinking...");

      try {
        const resp = await fetch("/ai/ask", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ prompt: text }),
        });

        if (!resp.ok) {
          thinkingEl.textContent = "Error: " + resp.status;
          return;
        }

        const data = await resp.json();
        thinkingEl.textContent = data.output || "(No response from model.)";
      } catch (err) {
        console.error(err);
        thinkingEl.textContent = "Network error. Please try again.";
      }
    }

    chatToggle.addEventListener("click", () => {
      chatWidget.classList.toggle("open");
    });

    chatSend.addEventListener("click", sendChat);

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendChat();
      }
    });
  </script>

  <!-- Notification helper -->
  <script>
    const notificationEl = document.getElementById("notification");
    let notificationTimeout;

    function showNotification(message, type = "success", duration = 3000) {
      if (!notificationEl) return;

      notificationEl.className = "notification";
      notificationEl.textContent = message;

      if (type === "success") {
        notificationEl.classList.add("notification-success");
      } else if (type === "error") {
        notificationEl.classList.add("notification-error");
      }

      notificationEl.classList.add("show");

      if (notificationTimeout) {
        clearTimeout(notificationTimeout);
      }
      notificationTimeout = setTimeout(() => {
        notificationEl.classList.remove("show");
      }, duration);
    }

    notificationEl?.addEventListener("click", () => {
      notificationEl.classList.remove("show");
    });
  </script>
</html>
