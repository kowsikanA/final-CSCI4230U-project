<!DOCTYPE html>
<html lang="en">
<head>
  <title></title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style/productDetails.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet"
  >
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  >
</head>

<body>
  <!-- Navbar -->
  <div class="main-navbar">
    <div class="navbar">
      <a href="{{ url_for('home') }}">
        <img
          src="{{ url_for('static', filename='images/logo-2.png') }}"
          alt="logo"
          class="logo"
        >
      </a>

      <ul class="nav-links">
        <div class="search-bar">
          <form action="">
            <input
              type="search"
              name="product-search"
              id="product-search"
              placeholder="Search for products"
            >
            <button class="search-btn">
              <i class="fa fa-search"></i>
            </button>
          </form>
        </div>
        <li class="link">
          <a href="{{ url_for('login') }}" id="auth-link">Sign In</a>
        </li>
        <li class="link">
          <a href="{{ url_for('carts') }}">
            <i
              class="fa fa-shopping-cart cart-icon"
              aria-hidden="true"
              style="font-size: 24px;"
            ></i>
          </a>
        </li>
      </ul>
    </div>

    <section>
      <div id="productDetails">
        <div class="productImages">
          <div class="imageGallery"></div>
          <div class="largeImage"></div>
        </div>

        <div class="productInfo">
          <h3 class="product-title"></h3>

          <div class="star-rating"></div>

          <p class="product-brand"></p>
          <p class="product-cost"></p>

          <div class="quantity-select">
            <button class="add-q">+</button>
            <p class="quantity"></p>
            <button class="subtract-q">-</button>
          </div>

          <p class="availability"></p>

          <button class="cart-btn">Add to Cart</button>
        </div>
      </div>

      <div class="related-products">
        <h2>Related Products</h2>
        <div class="products"></div>
      </div>

      <button class="accordion">About this Product</button>
      <div class="panel">
        <div class="product-description">
          <h3>About this Product</h3>
          <p class="description" style="margin-top: 10px; width: 200px;"></p>
        </div>
      </div>

      <button class="accordion">Specifications</button>
      <div class="panel">
        <div class="product-specs">
          <table>
            <th></th>
            <th></th>
            <th></th>
          </table>
        </div>
      </div>

      <button class="accordion">Customer Reviews</button>
      <div class="panel">
        <div class="product-ratings">
          <h3>Customer Reviews</h3>
          <div id="reviews-container"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Chat widget -->
  <div id="chat-widget">
    <div class="chat-header">NorthStar Assistant</div>
    <div class="chat-body" id="chat-body">
      <div class="chat-message bot">
        Hi! ðŸ‘‹. Have any questions about the products we sell, go ahead and ask us some questions.
      </div>
    </div>
    <div class="chat-input-row">
      <input
        type="text"
        id="chat-input"
        placeholder="What is the latest airpod generation?"
        autocomplete="off"
      >
      <button id="chat-send">Send</button>
    </div>
  </div>
  <button id="chat-toggle" aria-label="Open chat">ðŸ’¬</button>

  <div id="notification" class="notification"></div>

  <!-- ================= FOOTER ================= -->
  <footer class="footer">
    <div class="footer-container">
      <div class="footer-section">
        <img
          src="{{ url_for('static', filename='images/logo-2.png') }}"
          class="footer-logo"
          alt="NorthStar Goods"
        >
        <p>Your trusted online store for tech, lifestyle, and more.</p>
      </div>

      <div class="footer-section">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="{{ url_for('home') }}">Home</a></li>
          <li><a href="{{ url_for('carts') }}">My Cart</a></li>
          <li><a href="{{ url_for('login') }}">Sign In</a></li>
        </ul>
      </div>

      <div class="footer-section">
        <h4>Customer Service</h4>
        <ul>
          <li><a href="#">Contact Us</a></li>
          <li><a href="#">Refund Policy</a></li>
          <li><a href="#">Shipping Info</a></li>
          <li><a href="#">FAQ</a></li>
        </ul>
      </div>

      <div class="footer-section">
        <h4>Follow Us</h4>
        <div class="footer-socials">
          <a href="#"><i class="fa fa-facebook"></i></a>
          <a href="#"><i class="fa fa-instagram"></i></a>
          <a href="#"><i class="fa fa-twitter"></i></a>
          <a href="#"><i class="fa fa-youtube-play"></i></a>
        </div>
      </div>
    </div>

    <div class="footer-bottom">
      <p>Â© 2025 NorthStar Goods â€” All Rights Reserved.</p>
    </div>
  </footer>
  <!-- =============== END FOOTER =============== -->
</body>

<!-- Login / logout helper -->
<script>
  (function () {
    const FLAG_KEY = "ns_initial_logout_done";

    if (!sessionStorage.getItem(FLAG_KEY)) {
      localStorage.removeItem("access_token");
      sessionStorage.setItem(FLAG_KEY, "1");
    }
  })();

  function handleLogout(event) {
    event.preventDefault();
    localStorage.removeItem("access_token");
    window.location.href = "{{ url_for('login') }}";
  }

  function updateAuthLink() {
    const authLink = document.getElementById("auth-link");
    if (!authLink) return;

    const token = localStorage.getItem("access_token");

    if (token) {
      authLink.textContent = "Sign Out";
      authLink.href = "#";
      authLink.onclick = handleLogout;
    } else {
      authLink.textContent = "Sign In";
      authLink.href = "{{ url_for('login') }}";
      authLink.onclick = null;
    }
  }

  document.addEventListener("DOMContentLoaded", updateAuthLink);
</script>

<!-- Accordion logic -->
<script>
  const accordian = document.getElementsByClassName("accordion");
  let i;

  for (i = 0; i < accordian.length; i++) {
    accordian[i].addEventListener("click", function () {
      this.classList.toggle("active");
      const panel = this.nextElementSibling;
      if (panel.style.display === "block") {
        panel.style.display = "none";
      } else {
        panel.style.display = "block";
      }
    });
  }
</script>

<!-- Related products -->
<script>
  async function fetchRelatedProducts(tag) {
    const container = document.querySelector(".related-products .products");
    container.innerHTML = "";

    if (!tag) return;

    try {
      const res = await fetch(
        `https://dummyjson.com/products/category/${encodeURIComponent(tag)}`
      );
      if (!res.ok) {
        throw new Error(`Status ${res.status}`);
      }

      const data = await res.json();
      const products = data.products || [];

      if (products.length === 0) {
        container.innerHTML = "<p>No related products found.</p>";
        return;
      }

      products.forEach((prod) => {
        const card = document.createElement("div");
        card.className = "related-product-card";

        card.innerHTML = `
          <img src="${prod.thumbnail}" alt="${prod.title}" class="related-product-img" />
          <h4 class="related-product-title">${prod.title}</h4>
          <p class="related-product-price">$${prod.price}</p>
        `;

        card.addEventListener("click", () => {
          localStorage.setItem("selectedProductId", prod.id);
          window.location.href = "/productDetails";
        });

        container.appendChild(card);
      });
    } catch (err) {
      console.error(err);
      container.innerHTML = "<p>Failed to load related products.</p>";
    }
  }
</script>

<!-- Product details, specs, quantity, add to cart -->
<script>
  let currentProduct = null;
  const largeImage = document.querySelector(".largeImage");
  const imageGallery = document.querySelector(".imageGallery");

  async function getData() {
    const productId = localStorage.getItem("selectedProductId");
    if (!productId) {
      console.error("No product ID found in localStorage");
      return;
    }

    const url = `https://dummyjson.com/products/${productId}`;

    try {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`Response status ${res.status}`);
      }

      currentProduct = await res.json();

      const mainImg = document.createElement("img");
      mainImg.className = "main-img";
      mainImg.src = currentProduct.thumbnail;
      largeImage.innerHTML = "";
      largeImage.append(mainImg);

      const imagesArray = currentProduct.images;
      imagesArray.forEach((smallImage) => {
        const viewImg = document.createElement("img");
        viewImg.src = smallImage;
        viewImg.className = "viewImg";
        imageGallery.append(viewImg);

        viewImg.onclick = function () {
          mainImg.src = viewImg.src;
        };
      });

      document.querySelector(".product-title").textContent = currentProduct.title;
      document.querySelector(".product-cost").textContent = `$${currentProduct.price}`;
      document.querySelector(".product-brand").textContent = `Brand: ${currentProduct.brand}`;
      document.querySelector(".description").textContent = currentProduct.description;

      const starContainer = document.querySelector(".star-rating");
      const ratingValue = currentProduct.rating;

      starContainer.innerHTML = "";

      const starsDiv = generateStars(ratingValue);
      while (starsDiv.firstChild) {
        starContainer.appendChild(starsDiv.firstChild);
      }

      const ratingText = document.createElement("span");
      ratingText.textContent = `${ratingValue.toFixed(1)} / 5`;
      starContainer.appendChild(ratingText);

      const availabilityStatus = document.querySelector(".availability");
      const statusValue = currentProduct.availabilityStatus
        ? currentProduct.availabilityStatus.trim()
        : "Unknown";

      availabilityStatus.innerHTML = `Availability Status: <span>${statusValue}</span>`;
      const span = availabilityStatus.querySelector("span");
      span.style.fontWeight = "bold";

      const statusLower = statusValue.toLowerCase();
      if (statusLower === "low stock") {
        span.style.color = "orange";
      } else if (statusLower === "out of stock" || statusLower === "unavailable") {
        span.style.color = "red";
      } else if (statusLower === "in stock" || statusLower === "available") {
        span.style.color = "green";
      } else {
        span.style.color = "gray";
      }

      const specsTable = document.querySelector(".product-specs table");
      const possibleSources = [
        currentProduct.category,
        currentProduct.dimensions,
        currentProduct.details,
        currentProduct.warrantyInformation,
        currentProduct.returnPolicy,
      ];

      let mergedEntries = [];
      possibleSources.forEach((source) => {
        if (!source) return;

        if (typeof source === "object" && !Array.isArray(source)) {
          mergedEntries.push(...Object.entries(source));
        } else if (Array.isArray(source)) {
          source.forEach((item) => {
            if (item.key && item.value) {
              mergedEntries.push([item.key, item.value]);
            }
          });
        } else if (typeof source === "string") {
          mergedEntries.push(["Category", source]);
        }
      });

      mergedEntries = mergedEntries.filter(
        (v, i, arr) => arr.findIndex((t) => t[0] === v[0]) === i
      );

      specsTable.innerHTML = "";

      if (mergedEntries.length === 0) {
        specsTable.innerHTML = `<tr><td>No specifications available</td></tr>`;
      } else {
        specsTable.innerHTML = `
          <tr>
            <th>Specification</th>
            <th>Details</th>
          </tr>
        `;

        mergedEntries.forEach(([key, value]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${key}</td><td>${value}</td>`;
          specsTable.appendChild(tr);
        });
      }

      if (currentProduct && currentProduct.category) {
        fetchRelatedProducts(currentProduct.category);
      }
    } catch (error) {
      console.error(error.message);
    }
  }

  getData();

  const addQ = document.querySelector(".add-q");
  const quantityDisplay = document.querySelector(".quantity");
  const subtractQ = document.querySelector(".subtract-q");

  let quantity = 1;
  quantityDisplay.textContent = quantity;

  addQ.addEventListener("click", () => {
    quantity++;
    quantityDisplay.textContent = quantity;
  });

  subtractQ.addEventListener("click", () => {
    if (quantity > 1) {
      quantity--;
      quantityDisplay.textContent = quantity;
    }
  });

  const modalAddToCartBtn = document.querySelector(".cart-btn");

  modalAddToCartBtn.addEventListener("click", async () => {
    if (!currentProduct) return;

    const token = localStorage.getItem("access_token");
    if (!token) {
      showNotification("Please sign in before adding items to your cart.", "error");
      setTimeout(() => {
        window.location.href = "/login";
      }, 2000);
      return;
    }

    try {
      const res = await fetch("/api/cart", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({
          product_id: currentProduct.id,
          name: currentProduct.title,
          price: currentProduct.price,
          image_url: currentProduct.thumbnail,
          description: currentProduct.description,
          quantity: quantity,
        }),
      });

      const data = await res.json();

      if (!res.ok) {
        const message = data.error || "Could not add this product to your cart.";
        showNotification(message, "error");
        return;
      }

      showNotification(`Added "${currentProduct.title}" to your cart.`, "success");
    } catch (err) {
      console.error(err);
      showNotification(
        "We ran into a network error. Please try again in a moment.",
        "error"
      );
    }
  });
</script>

<!-- Star generation + reviews -->
<script>
  function generateStars(rating) {
    const starDiv = document.createElement("div");
    starDiv.className = "star-rating";

    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

    for (let i = 0; i < fullStars; i++) {
      const star = document.createElement("i");
      star.className = "fa-solid fa-star";
      starDiv.appendChild(star);
    }

    if (hasHalfStar) {
      const halfStar = document.createElement("i");
      halfStar.className = "fa-solid fa-star-half-stroke";
      starDiv.appendChild(halfStar);
    }

    for (let i = 0; i < emptyStars; i++) {
      const star = document.createElement("i");
      star.className = "fa-regular fa-star";
      starDiv.appendChild(star);
    }

    return starDiv;
  }

  async function fetchReviews() {
    const productId = localStorage.getItem("selectedProductId");
    if (!productId) return;

    const url = `https://dummyjson.com/products/${productId}`;

    try {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`Response status ${res.status}`);
      }

      const data = await res.json();
      const reviews = data.reviews || [];

      const ratingContainer = document.getElementById("reviews-container");
      ratingContainer.innerHTML = "";

      if (reviews.length === 0) {
        ratingContainer.innerHTML = `<p>No reviews available for this product</p>`;
        return;
      }

      reviews.forEach((review) => {
        const customerReviewDiv = document.createElement("div");
        customerReviewDiv.className = "rating-customer";

        const iconDiv = document.createElement("div");
        iconDiv.className = "icon-container";
        iconDiv.innerHTML = `<i class="fa-solid fa-user"></i>`;

        const contentDiv = document.createElement("div");
        contentDiv.className = "customer-review";

        const nameEl = document.createElement("h4");
        nameEl.textContent = review.reviewerName;

        const emailEl = document.createElement("p");
        emailEl.className = "email";
        emailEl.textContent = review.reviewerEmail;

        const starDiv = generateStars(review.rating);

        const dateEl = document.createElement("p");
        dateEl.className = "dateCreated";
        dateEl.textContent = new Date(review.date).toLocaleDateString();

        starDiv.appendChild(dateEl);

        const commentEl = document.createElement("p");
        commentEl.className = "reviewInfo";
        commentEl.textContent = review.comment;

        contentDiv.append(nameEl, emailEl, starDiv, commentEl);
        customerReviewDiv.append(iconDiv, contentDiv);
        ratingContainer.appendChild(customerReviewDiv);
      });
    } catch (err) {
      console.error(err);
    }
  }

  document.addEventListener("DOMContentLoaded", fetchReviews);
</script>

<!-- Notification helper -->
<script>
  const notificationEl = document.getElementById("notification");
  let notificationTimeout;

  function showNotification(message, type = "success", duration = 3000) {
    if (!notificationEl) return;

    notificationEl.className = "notification";
    notificationEl.textContent = message;

    if (type === "success") {
      notificationEl.classList.add("notification-success");
    } else if (type === "error") {
      notificationEl.classList.add("notification-error");
    }

    notificationEl.classList.add("show");

    if (notificationTimeout) {
      clearTimeout(notificationTimeout);
    }
    notificationTimeout = setTimeout(() => {
      notificationEl.classList.remove("show");
    }, duration);
  }

  notificationEl?.addEventListener("click", () => {
    notificationEl.classList.remove("show");
  });
</script>

<!-- Chat widget logic -->
<script>
  const chatWidget = document.getElementById("chat-widget");
  const chatToggle = document.getElementById("chat-toggle");
  const chatBody = document.getElementById("chat-body");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");

  function appendMessage(role, text) {
    const msg = document.createElement("div");
    msg.className = "chat-message " + role;
    msg.textContent = text;
    chatBody.appendChild(msg);
    chatBody.scrollTop = chatBody.scrollHeight;
    return msg;
  }

  async function sendChat() {
    const text = (chatInput.value || "").trim();
    if (!text) return;

    appendMessage("user", text);
    chatInput.value = "";

    const thinkingEl = appendMessage("bot", "Thinking...");

    try {
      const resp = await fetch("/ai/ask", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ prompt: text }),
      });

      if (!resp.ok) {
        thinkingEl.textContent = "Error: " + resp.status;
        return;
      }

      const data = await resp.json();
      thinkingEl.textContent = data.output || "(No response from model.)";
    } catch (err) {
      console.error(err);
      thinkingEl.textContent = "Network error. Please try again.";
    }
  }

  chatToggle.addEventListener("click", () => {
    chatWidget.classList.toggle("open");
  });

  chatSend.addEventListener("click", sendChat);

  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendChat();
    }
  });
</script>
</html>
