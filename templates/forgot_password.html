<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forgot Password</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style/forgot.css') }}">
</head>
<body>
  <div id="notification" class="notification"></div>

  <section id="forgot-section">
    <div class="forgot-container">
      <div class="title">
        <a href="{{ url_for('home') }}">
          <svg
            class="home-icon"
            xmlns="http://www.w3.org/2000/svg"
            x="0px"
            y="0px"
            width="30"
            height="30"
            viewBox="0 0 50 50"
          >
            <path d="M 25 1.0507812 C 24.7825 1.0507812 24.565859 1.1197656 24.380859 1.2597656 L 1.3808594 19.210938 C 0.95085938 19.550938 0.8709375 20.179141 1.2109375 20.619141 C 1.5509375 21.049141 2.1791406 21.129062 2.6191406 20.789062 L 4 19.710938 L 4 46 C 4 46.55 4.45 47 5 47 L 19 47 L 19 29 L 31 29 L 31 47 L 45 47 C 45.55 47 46 46.55 46 46 L 46 19.710938 L 47.380859 20.789062 C 47.570859 20.929063 47.78 21 48 21 C 48.3 21 48.589063 20.869141 48.789062 20.619141 C 49.129063 20.179141 49.049141 19.550938 48.619141 19.210938 L 25.619141 1.2597656 C 25.434141 1.1197656 25.2175 1.0507812 25 1.0507812 z M 35 5 L 35 6.0507812 L 41 10.730469 L 41 5 L 35 5 z"></path>
          </svg>
        </a>
        <h2>Reset your password</h2>
      </div>

      <div class="inputs">
        <label for="fp-email">Email</label>
        <input type="email" id="fp-email" required>

        <label for="fp-answer">Security Answer</label>
        <input type="text" id="fp-answer" required>

        <label for="fp-new-password">New Password</label>
        <input type="password" id="fp-new-password" required>

        <label for="fp-confirm-password">Confirm New Password</label>
        <input type="password" id="fp-confirm-password" required>
      </div>

      <button class="forgot-btn" onclick="resetPassword()">Reset Password</button>
      <h4><a class="signup-link" href="/login">Back to Login</a></h4>
    </div>
  </section>

  <script>
    const notificationEl = document.getElementById("notification");
    let notificationTimeout;

    function showNotification(message, type = "success", duration = 3000) {
      if (!notificationEl) return;

      notificationEl.className = "notification";
      notificationEl.textContent = message;

      if (type === "success") {
        notificationEl.classList.add("notification-success");
      } else if (type === "error") {
        notificationEl.classList.add("notification-error");
      }

      notificationEl.classList.add("show");

      if (notificationTimeout) {
        clearTimeout(notificationTimeout);
      }

      notificationTimeout = setTimeout(() => {
        notificationEl.classList.remove("show");
      }, duration);
    }

    notificationEl?.addEventListener("click", () => {
      notificationEl.classList.remove("show");
    });

    async function resetPassword() {
      const email = document.getElementById("fp-email").value;
      const answer = document.getElementById("fp-answer").value;
      const newPassword = document.getElementById("fp-new-password").value;
      const confirmPassword = document.getElementById("fp-confirm-password").value;

      try {
        const res = await fetch("/auth/forgot-password", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            email: email,
            security_answer: answer,
            new_password: newPassword,
            confirm_password: confirmPassword
          })
        });

        const data = await res.json();

        if (!res.ok) {
          showNotification(data.error || "Could not reset password.", "error");
          return;
        }

        showNotification(data.message || "Password updated!", "success");
        setTimeout(() => {
          window.location.href = "/login";
        }, 1500);
      } catch (err) {
        console.error(err);
        showNotification("Network error. Please try again.", "error");
      }
    }
  </script>
</body>
</html>
