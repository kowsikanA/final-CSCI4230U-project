<!DOCTYPE html>
<html lang="en">
  <head>
    <title>NorthStar Goods</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='style/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  </head>
  <body>
    <!-- Navbar -->
    <div class="main-navbar">
      <div class="navbar">
        <a href="{{ url_for('home') }}"><img src="{{ url_for('static', filename='images/logo-2.png') }}" alt="logo" class="logo"></a>
        
        <ul class="nav-links">
          <div class="search-bar">
            <form action="">
              <input type="search" name="product-search" id="product-search" placeholder="Search for products">
              <button class="search-btn"><i class="fa fa-search"></i></button>
            </form>
          </div>
          <li class="link"><a href="{{ url_for('login') }}" id="auth-link">Sign In</a></li>
          <li class="link"><a href="{{ url_for('carts') }}"><i class="fa fa-shopping-cart cart-icon" aria-hidden="true" style="font-size: 24px;"></i></a></li>
        </ul>
      </div>

      <div class="categories">
        <ul>
          <li style="font-weight: 500;">Black Friday</li>
          <li>Electronics</li>
          <li>Home Appliances</li>
          <li>Clothes</li>
          <li>Sports</li>
          <li>Gaming</li>
          <li>Toys</li>
          <li>Groceries</li>
        </ul>
      </div>
  </div>

  <!-- Special offer grid -->

    <div class="offers">
      <h1 style="color: #F8FAFC;font-size: 45px;">Black Friday Offers</h1>
      <div id="product-list">
      <!-- <div class="product-card">
        <img src="/Product-Images/Apple iPad 10.9 inch.jpg" alt="" style="width: 100%;">

      </div> -->
      </div>
    </div>

        <!-- Product details modal -->
    <div id="product-modal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <button class="modal-close" id="modal-close">&times;</button>

        <img id="modal-image" class="modal-image" src="" alt="Product image" />

        <h2 id="modal-title" class="modal-title"></h2>
        <p id="modal-category" class="modal-category"></p>
        <p id="modal-price" class="modal-price"></p>
        <p id="modal-description" class="modal-description"></p>

        <button id="modal-view-details" class="more-details-btn">View Details</button>

        <button id="modal-add-to-cart" class="cart-btn">
          Add to Cart
        </button>
      </div>
    </div>



    <!-- Code for chatbox -sr -->
    <div id="chat-widget">
      <div class="chat-header">NorthStar Assistant</div>
      <div class="chat-body" id="chat-body">
        <div class="chat-message bot">
          Hi! ðŸ‘‹. Have any questions about the products we sell, go ahead and ask us some questions. 
        </div>
      </div>
      <div class="chat-input-row">
        <input type="text" id="chat-input" placeholder="What is the latest airpod generation?" autocomplete="off"/>
        <button id="chat-send">Send</button>
      </div>
    </div>
    <button id="chat-toggle" aria-label="Open chat">ðŸ’¬</button>

    <div id="notification" class="notification"></div>

  </body>

  
<script>
  // Login/logout checker and helper
  (function () {
  // Only run this once per browser session
  const FLAG_KEY = "ns_initial_logout_done";

  if (!sessionStorage.getItem(FLAG_KEY)) {
    // Clear any old auth token from previous sessions
    localStorage.removeItem("access_token");
    // Mark that we've done the initial logout
    sessionStorage.setItem(FLAG_KEY, "1");
  }
})();

  function handleLogout(event) {
    event.preventDefault();

    // Clear the token (this is what "logs out" a JWT-based app)
    localStorage.removeItem("access_token");

    // Optional: clear any other auth-related stuff here (e.g. username)
    // localStorage.removeItem("user_email");

    // Simple feedback (use your notification helper if you have one)
    // showNotification("You have been signed out.", "success");

    // Redirect to login page (or home page if you prefer)
    window.location.href = "{{ url_for('login') }}";
  }

  function updateAuthLink() {
    const authLink = document.getElementById("auth-link");
    if (!authLink) return;

    const token = localStorage.getItem("access_token");

    if (token) {
      // User is "logged in" (token exists)
      authLink.textContent = "Sign Out";
      authLink.href = "#";          // we handle click ourselves
      authLink.onclick = handleLogout;
    } else {
      // No token â†’ treat as logged out
      authLink.textContent = "Sign In";
      authLink.href = "{{ url_for('login') }}";
      authLink.onclick = null;
    }
  }

  // Run once when the page loads
  document.addEventListener("DOMContentLoaded", updateAuthLink);
</script>

  

  <script>
  // ----- logic -----
  let selectedProduct = null;
  let allProducts = []; // This will store all the fetched items - NEW CODE

  // Fetch products from DummyJSON and render only tech devices
  // async function fetchProducts() {
  //   try {
  //     // 1) Get ALL products but only the fields we care about
  //     const res = await fetch(
  //       "https://dummyjson.com/products?limit=0&select=title,price,thumbnail,category,description"
  //     );

  //     if (!res.ok) {
  //       throw new Error(`Response status: ${res.status}`);
  //     }

  //     // 2) DummyJSON returns: { products: [...], total, skip, limit }
  //     const data = await res.json();
  //     let products = data.products || [];

  //     // 3) Keep only tech-type categories
  //     const allowedCategories = [
  //       "fragrances",
  //       "groceries"
  //     ];

  //     products = products.filter((product) =>
  //       allowedCategories.includes(product.category)
  //     );

  //     // 4) Get container
  //     const productListDiv = document.getElementById("product-list");
  //     if (!productListDiv) {
  //       console.error("No element with id 'product-list' found in the DOM.");
  //       return;
  //     }

  //     productListDiv.innerHTML = "";

  //     if (products.length === 0) {
  //       productListDiv.innerHTML =
  //         "<p style='color:white;'>No tech products found.</p>";
  //       return;
  //     }

  //     // 5) Render cards (no direct Add to Cart here; click opens modal)
  //     products.forEach((product) => {
  //       const productDiv = document.createElement("div");
  //       productDiv.className = "product";

  //       const img = document.createElement("img");
  //       img.src = product.thumbnail;
  //       img.alt = product.title;
  //       img.className = "product-image";

  //       const title = document.createElement("p");
  //       title.className = "product-name";
  //       title.textContent =
  //         product.title.length > 25
  //           ? product.title.substring(0, 25) + "..."
  //           : product.title;

  //       const price = document.createElement("h3");
  //       price.className = "product-price";
  //       price.textContent = `$${product.price}`;

  //       const category = document.createElement("p");
  //       category.className = "product-category";
  //       category.textContent = product.category;

  //       // Entire card clickable â†’ open modal
  //       productDiv.addEventListener("click", () => {
  //         openProductModal(product);
  //       });

  //       productDiv.appendChild(img);
  //       productDiv.appendChild(title);
  //       productDiv.appendChild(price);
  //       // productDiv.appendChild(category);

  //       productListDiv.appendChild(productDiv);
  //     });
  //   } catch (error) {
  //     console.error("Error fetching products:", error);

  //     const productListDiv = document.getElementById("product-list");
  //     if (productListDiv) {
  //       productListDiv.innerHTML =
  //         "<p style='color:white;'>Sorry, we couldn't load the products right now.</p>";
  //     }
  //     showNotification("We couldn't load products. Please refresh the page.", "error");
  //   }
  // }

    // Create / update cards based on a given product array
  function renderProducts(products) {
    const productListDiv = document.getElementById("product-list");
    if (!productListDiv) {
      console.error("No element with id 'product-list' found in the DOM.");
      return;
    }

    // Clear previous cards
    productListDiv.innerHTML = "";

    if (!products || products.length === 0) {
      productListDiv.innerHTML =
        "<p style='color:white;'>No products found.</p>";
      return;
    }

    products.forEach((product) => {
      const productDiv = document.createElement("div");
      productDiv.className = "product";

      const img = document.createElement("img");
      img.src = product.thumbnail;
      img.alt = product.title;
      img.className = "product-image";

      const title = document.createElement("p");
      title.className = "product-name";
      title.textContent =
        product.title.length > 25
          ? product.title.substring(0, 25) + "..."
          : product.title;

      const price = document.createElement("h3");
      price.className = "product-price";
      price.textContent = `$${product.price}`;

      // Entire card clickable â†’ open modal
      productDiv.addEventListener("click", () => {
        openProductModal(product);
      });

      productDiv.appendChild(img);
      productDiv.appendChild(title);
      productDiv.appendChild(price);
      // productDiv.appendChild(category); // if you want category displayed too

      productListDiv.appendChild(productDiv);
    });
  }

  // Fetch products from DummyJSON and keep them in memory
  async function fetchProducts() {
    try {
      // 1) Get ALL products but only the fields we care about
      const res = await fetch(
        "https://dummyjson.com/products?limit=0&select=title,price,thumbnail,category,description"
      );

      if (!res.ok) {
        throw new Error(`Response status: ${res.status}`);
      }

      // 2) DummyJSON returns: { products: [...], total, skip, limit }
      const data = await res.json();
      let products = data.products || [];

      // 3) Keep only the categories you care about
      const allowedCategories = ["fragrances", "groceries"];

      products = products.filter((product) =>
        allowedCategories.includes(product.category)
      );

      // 4) Save for searching and render once
      allProducts = products;
      renderProducts(products);
    } catch (error) {
      console.error("Error fetching products:", error);

      const productListDiv = document.getElementById("product-list");
      if (productListDiv) {
        productListDiv.innerHTML =
          "<p style='color:white;'>Sorry, we couldn't load the products right now.</p>";
      }

      // Use your existing notification helper if you like
      showNotification(
        "We couldn't load products. Please refresh the page.",
        "error"
      );
    }
  }


  // ----- Modal logic -----
  const modal = document.getElementById("product-modal");
  const modalImage = document.getElementById("modal-image");
  const modalTitle = document.getElementById("modal-title");
  const modalCategory = document.getElementById("modal-category");
  const modalPrice = document.getElementById("modal-price");
  const modalDescription = document.getElementById("modal-description");
  const modalCloseBtn = document.getElementById("modal-close");
  const modalAddToCartBtn = document.getElementById("modal-add-to-cart");
  
  const viewDetailsBtn = document.getElementById("modal-view-details");

  function openProductModal(product) {
    selectedProduct = product;

    modalImage.src = product.thumbnail;
    modalImage.alt = product.title;
    modalTitle.textContent = product.title;
    modalCategory.textContent = `Category: ${product.category}`;
    modalPrice.textContent = `Price: $${product.price}`;
    modalDescription.textContent = product.description || "No description available.";

    modal.classList.remove("hidden");
  }

  function closeProductModal() {
    modal.classList.add("hidden");
    selectedProduct = null;
  }

  // Close when clicking X
  modalCloseBtn.addEventListener("click", closeProductModal);

  // Close when clicking outside the card (on the backdrop)
  modal.addEventListener("click", (e) => {
    if (e.target === modal || e.target.classList.contains("modal-backdrop")) {
      closeProductModal();
    }
  });

  
  modalAddToCartBtn.addEventListener("click", async() => {
    if (!selectedProduct) return;

    const token = localStorage.getItem("access_token");
    if (!token){
      showNotification("Please sign in before adding items to your cart.", "error");
      setTimeout(()=> {         
            window.location.href='/login';}, 2000);
      return;
    }

    try{
      const res = await fetch('/api/cart', {
        method:"POST",
        headers:{
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        }, 
        body: JSON.stringify({
          product_id: selectedProduct.id,            
          name: selectedProduct.title,              
          price: selectedProduct.price,             
          image_url: selectedProduct.thumbnail,     
          description: selectedProduct.description, 
          quantity: 1,
        })     
      });
      const data = await res.json();

      if(!res.ok){
        const message = data.error || "Could not add this product to your cart.";
        showNotification(message, "error");
        return;
      }

      showNotification(`Added "${selectedProduct.title}" to your cart.`, "success"); 
      closeProductModal();

    } catch (err){
      console.error(err);
      showNotification("We ran into a network error. Please try again in a moment.", "error");
    }

    // TODO: later we can POST to your Flask cart endpoint here.
    // console.log("Add to cart:", selectedProduct);
    // alert(`Added "${selectedProduct.title}" to cart (mock).`);
    // closeProductModal();
  });

  viewDetailsBtn.addEventListener("click", function (){
    if (!selectedProduct) return;

    localStorage.setItem("selectedProductId", selectedProduct.id);

    window.location.href = "/productDetails";

  });












  const searchInput = document.getElementById("product-search");
  const searchButton = document.querySelector(".search-btn");

  function handleSearch() {
    // If products haven't loaded yet, do nothing
    if (!allProducts || allProducts.length === 0) {
      return;
    }

    const query = searchInput.value.trim().toLowerCase();

    // Empty search â†’ show all products again
    if (!query) {
      renderProducts(allProducts);
      return;
    }

    const filtered = allProducts.filter((product) => {
      return (
        product.title.toLowerCase().includes(query) ||
        product.category.toLowerCase().includes(query)
      );
    });

    renderProducts(filtered);
  }

  if (searchInput && searchButton) {
    // Click on the search icon
    searchButton.addEventListener("click", (event) => {
      event.preventDefault();
      handleSearch();
    });

    // Press Enter inside the search box
    searchInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        handleSearch();
      }
    });
  }



  // Run on page load
  fetchProducts();
</script>








 <script>

  // ----- Chat widget logic -----
  const chatWidget = document.getElementById("chat-widget");
  const chatToggle = document.getElementById("chat-toggle");
  const chatBody = document.getElementById("chat-body");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");

  function appendMessage(role, text) {
    const msg = document.createElement("div");
    msg.className = "chat-message " + role;
    msg.textContent = text;
    chatBody.appendChild(msg);
    chatBody.scrollTop = chatBody.scrollHeight;
    return msg;
  }

  async function sendChat() {
    const text = (chatInput.value || "").trim();
    if (!text) return;

    appendMessage("user", text);
    chatInput.value = "";

    const thinkingEl = appendMessage("bot", "Thinking...");

    try {
      const resp = await fetch("/ai/ask", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ prompt: text }),
      });

      if (!resp.ok) {
        thinkingEl.textContent = "Error: " + resp.status;
        return;
      }

      const data = await resp.json();
      thinkingEl.textContent = data.output || "(No response from model.)";
    } catch (err) {
      console.error(err);
      thinkingEl.textContent = "Network error. Please try again.";
    }
  }

  // Toggle open/close when clicking the bubble
  chatToggle.addEventListener("click", () => {
    chatWidget.classList.toggle("open");
  });

  // Send on button click
  chatSend.addEventListener("click", sendChat);

  // Send on Enter key (Shift+Enter = newline ignored since it's a single-line input)
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendChat();
    }
  });
</script>


<script>
  // ----- Top notification helper -----
  const notificationEl = document.getElementById("notification");
  let notificationTimeout;

  function showNotification(message, type = "success", duration = 3000) {
    if (!notificationEl) return;

    // Reset classes
    notificationEl.className = "notification";
    notificationEl.textContent = message;

    if (type === "success") {
      notificationEl.classList.add("notification-success");
    } else if (type === "error") {
      notificationEl.classList.add("notification-error");
    }

    notificationEl.classList.add("show");

    // Auto-hide after duration
    if (notificationTimeout) {
      clearTimeout(notificationTimeout);
    }
    notificationTimeout = setTimeout(() => {
      notificationEl.classList.remove("show");
    }, duration);
  }

  // Optional: allow user to click to dismiss immediately
  notificationEl?.addEventListener("click", () => {
    notificationEl.classList.remove("show");
  });
</script>
  
</html>